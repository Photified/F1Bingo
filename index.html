<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 2026: CHAMPIONSHIP BINGO</title>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,600;0,700;0,900;1,400&display=swap" rel="stylesheet">
    
    <script src="bingo_data.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --brand-red: #e10600;
            --brand-dark: #15151e;
            --bg-body: #f4f4f8;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
            
            /* Category Colors */
            --c-driver: #ff9500; --c-team: #00d2be; --c-tech: #0070ff; --c-chaos: #e10600;
            --score-win: #39ff14; 
        }

        body {
            font-family: 'Titillium Web', sans-serif;
            background: var(--bg-body); color: var(--brand-dark);
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- LAYOUT COMPONENTS --- */
        header {
            background: white; border-bottom: 3px solid var(--brand-red);
            padding: 10px 25px; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0;
        }
        .header-title { font-weight:900; font-style:italic; font-size:22px; cursor: help; user-select: none; }
        
        .user-profile { font-weight: 700; display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .status-dot { width: 10px; height: 10px; background: #ccc; border-radius: 50%; }
        .status-dot.online { background: #00d2be; box-shadow: 0 0 8px #00d2be; }

        /* --- RACE BAR --- */
        .race-bar {
            background: #fff; padding: 0; display: flex; overflow-x: auto;
            border-bottom: 1px solid #ddd; scrollbar-width: thin; height: 85px; flex-shrink: 0;
        }
        .race-card {
            flex: 0 0 80px; padding: 10px 5px; text-align: center; border-right: 1px solid #f0f0f0;
            cursor: pointer; opacity: 0.6; transition: 0.2s; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .race-card:hover { opacity: 1; background: #f9f9f9; }
        .race-card.active { opacity: 1; border-bottom: 4px solid var(--brand-red); background: #fff; }
        .race-flag-img { width: 32px; height: 24px; object-fit: cover; border-radius: 3px; margin-bottom: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .race-name { font-size: 11px; font-weight: 800; text-transform: uppercase; line-height: 1; }

        /* --- MAIN STAGE --- */
        .main-stage {
            flex: 1; display: grid; grid-template-columns: 300px 1fr 280px;
            padding: 20px; gap: 20px; overflow: hidden; height: 100%;
        }

        .panel {
            background: white; border-radius: 10px; box-shadow: var(--card-shadow);
            overflow: hidden; display: flex; flex-direction: column; border: 1px solid #e0e0e0; height: 100%;
        }
        .panel-header {
            padding: 12px; background: #f8f8f8; font-weight: 800; font-size: 13px;
            text-transform: uppercase; border-bottom: 1px solid #ddd; text-align: center; color: #666; flex-shrink: 0;
        }

        /* --- POOL & TABS --- */
        .pool-container { display: flex; flex-direction: column; height: 100%; }
        .pool-tabs-header {
            padding: 10px; background: white; border-bottom: 1px solid #eee;
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex-shrink: 0;
        }
        .tab-btn {
            padding: 8px; text-align: center; cursor: pointer; font-weight: 700;
            font-size: 11px; text-transform: uppercase; border-radius: 4px; background: #f4f4f4;
            color: #888; border-left: 4px solid transparent;
        }
        .tab-btn.active { background: #333; color: white; border-color: #333; }
        
        .tab-btn[data-cat="driver"] { border-left-color: var(--c-driver); }
        .tab-btn[data-cat="team"] { border-left-color: var(--c-team); }
        .tab-btn[data-cat="tech"] { border-left-color: var(--c-tech); }
        .tab-btn[data-cat="chaos"] { border-left-color: var(--c-chaos); }

        .pool-list { flex: 1; overflow-y: auto; padding: 12px; background: #fbfbfb; }
        .chip {
            padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px;
            font-size: 11px; font-weight: 700; cursor: grab; border-left: 5px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .chip.driver { border-left-color: var(--c-driver); }
        .chip.team { border-left-color: var(--c-team); }
        .chip.tech { border-left-color: var(--c-tech); }
        .chip.chaos { border-left-color: var(--c-chaos); }

        /* --- ACTIVE PANEL --- */
        .active-panel {
            background: white; border-radius: 10px; box-shadow: var(--card-shadow);
            border: 1px solid #e0e0e0; padding: 20px; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden; height: 100%;
        }

        /* Views */
        .view-login { text-align: center; width: 100%; max-width: 400px; }
        .login-input { padding: 15px; width: 100%; margin-top: 15px; text-align: center; border: 2px solid #eee; border-radius: 8px; }
        .login-btn { padding: 15px; width: 100%; margin-top: 15px; background: var(--brand-red); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 8px; }

        .view-strategy { text-align: center; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; overflow-y: auto; padding-top: 10px; }
        .strat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; max-width: 600px; width: 100%; }
        .strat-card { background: #f9f9f9; border: 2px solid #eee; border-radius: 10px; padding: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .strat-card:hover { border-color: var(--brand-red); background: #fff; }
        .mini-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; width: 50px; height: 50px; margin-bottom: 10px; opacity: 0.8; }
        .mg-c { background: #ddd; border-radius: 1px; }

        .view-game { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 100%; aspect-ratio: 1/1; margin: 0 auto; max-height: 550px; }
        .slot { background: #fafafa; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; text-align: center; padding: 4px; font-size: 11px; font-weight: 700; position: relative; }
        .slot.filled { border: none; color: white !important; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .slot.filled[data-type="driver"] { background: var(--c-driver); }
        .slot.filled[data-type="team"] { background: var(--c-team); }
        .slot.filled[data-type="tech"] { background: var(--c-tech); }
        .slot.filled[data-type="chaos"] { background: var(--c-chaos); }
        .slot.center { background: linear-gradient(135deg, #222, #000); color: var(--brand-red); border:none; font-size: 14px; text-transform: uppercase; }
        
        .slot.matched { opacity: 1; box-shadow: inset 0 0 0 4px var(--score-win); transform: scale(1.02); z-index: 5; }
        .slot.matched::after { content: '‚úì'; position: absolute; top: -8px; right: -8px; background: var(--score-win); color: black; border-radius: 50%; width: 20px; height: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center; }

        /* --- ADMIN OVERLAY --- */
        #adminOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 5000; display: none;
            align-items: center; justify-content: center;
        }
        .admin-box {
            background: #1a1a1a; color: white; width: 80%; max-width: 900px;
            height: 80%; border-radius: 12px; display: flex; flex-direction: column;
            border: 2px solid var(--brand-red); box-shadow: 0 0 50px rgba(225,6,0,0.2);
        }
        .admin-header {
            padding: 20px; background: #111; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .admin-content {
            flex: 1; overflow-y: auto; padding: 20px; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;
        }
        .toggle-item {
            background: #333; padding: 10px; border-radius: 4px; font-size: 11px;
            cursor: pointer; border: 1px solid #444; display: flex; align-items: center; gap: 10px;
        }
        .toggle-item.selected { background: var(--brand-red); color: white; border-color: var(--brand-red); }
        .toggle-check { width: 15px; height: 15px; border: 2px solid #aaa; border-radius: 3px; display: block; }
        .toggle-item.selected .toggle-check { background: white; border-color: white; }

        /* Utility */
        .leaderboard { flex: 1; overflow-y: auto; font-size: 12px; }
        .lb-row { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
        .hidden { display: none !important; }

    </style>
</head>
<body>

<div id="adminOverlay">
    <div class="admin-box">
        <div class="admin-header">
            <div>
                <h2 style="margin:0; font-style:italic;">RACE CONTROL</h2>
                <div style="font-size:12px; color:#888;">Select verified events for <span id="adminRaceName" style="color:white">AUSTRALIA</span></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="publishResults()" style="background:var(--score-win); color:black; border:none; padding:10px 20px; font-weight:bold; cursor:pointer;">PUBLISH RESULTS</button>
                <button onclick="toggleAdmin()" style="background:#333; color:white; border:none; padding:10px 20px; cursor:pointer;">CLOSE</button>
            </div>
        </div>
        <div class="admin-content" id="adminList">
            </div>
    </div>
</div>

<header>
    <div class="user-profile">
        <div class="status-dot" id="connectionDot"></div>
        <span id="displayTeamName">GUEST</span>
    </div>
    <div class="header-title" ondblclick="toggleAdmin()">F1 <span style="color:var(--brand-red)">2026</span> BINGO</div>
    <button onclick="saveToServer()" style="background:var(--brand-red); color:white; border:none; padding:8px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">CLOUD SAVE</button>
</header>

<div class="race-bar" id="raceBar"></div>

<div class="main-stage">
    
    <div class="panel">
        <div class="panel-header">Components</div>
        <div class="pool-container">
            <div class="pool-tabs-header">
                <div class="tab-btn active" data-cat="driver" onclick="setPool('driver')">üèéÔ∏è Drivers</div>
                <div class="tab-btn" data-cat="team" onclick="setPool('team')">üõ†Ô∏è Teams</div>
                <div class="tab-btn" data-cat="tech" onclick="setPool('tech')">‚ö° Tech</div>
                <div class="tab-btn" data-cat="chaos" onclick="setPool('chaos')">üö© Chaos</div>
            </div>
            <div id="pool" class="pool-list"></div>
        </div>
    </div>

    <div class="active-panel" id="mainPanel">
        
        <div id="view-login" class="view-login">
            <h1 style="font-style:italic;">TEAM PRINCIPAL LOGIN</h1>
            <input type="text" id="teamNameInput" class="login-input" placeholder="Team Name">
            <button class="login-btn" onclick="login()">Enter Paddock</button>
        </div>

        <div id="view-strategy" class="view-strategy hidden">
            <div style="display:flex; align-items:center; justify-content:center; gap:15px; margin-top:10px;">
                <img id="stratFlag" src="" style="width:60px; border-radius:4px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                <div style="text-align:left;">
                    <div style="font-weight:900; font-size:20px; font-style:italic;" id="stratRaceName">RACE</div>
                    <div style="font-size:11px; color:#888;">SELECT STRATEGY CARD</div>
                </div>
            </div>
            
            <div class="strat-grid">
                <div class="strat-card" onclick="confirmStrategy('balanced')">
                    <div class="mini-grid">
                        <div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div>
                        <div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div>
                        <div class="mg-c" style="background:var(--c-chaos)"></div>
                    </div>
                    <strong>‚öñÔ∏è Balanced</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('tech')">
                    <div class="mini-grid">
                        <div class="mg-c" style="background:var(--c-tech)"></div><div class="mg-c" style="background:var(--c-tech)"></div>
                        <div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-tech)"></div>
                        <div class="mg-c" style="background:var(--c-tech)"></div>
                    </div>
                    <strong>üîß Tech Heavy</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('chaos')">
                    <div class="mini-grid">
                        <div class="mg-c" style="background:var(--c-chaos)"></div><div class="mg-c" style="background:var(--c-chaos)"></div>
                        <div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-chaos)"></div>
                        <div class="mg-c" style="background:var(--c-chaos)"></div>
                    </div>
                    <strong>üö© Chaos Agent</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('driver')">
                    <div class="mini-grid">
                        <div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div>
                        <div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div>
                        <div class="mg-c" style="background:var(--c-driver)"></div>
                    </div>
                    <strong>üèéÔ∏è Silly Season</strong>
                </div>
            </div>
        </div>

        <div id="view-game" class="view-game hidden">
            <div id="grid" class="bingo-grid"></div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">üèÜ Standings</div>
        <div style="padding:10px; text-align:center; font-size:12px;" id="currentScoreDisplay">Race Score: 0</div>
        <div class="leaderboard" id="leaderboardList" style="flex:1; overflow-y:auto; padding:10px;">
            <div style="text-align:center; color:#999;">Waiting for Login...</div>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const firebaseConfig = { apiKey: "YOUR_API_KEY" }; 
    let db, auth, isOffline = true;
    
    let currentUser = null;
    let activeRace = 'aus';
    let currentGrid = Array(25).fill(null);
    let currentPoolCat = 'driver';
    let verifiedResults = [];

    const templates = {
        balanced: ['driver','driver','team','tech','chaos','driver','team','tech','chaos','driver','team','tech','FREE','driver','team','tech','chaos','driver','team','tech','chaos','driver','team','tech','chaos'],
        tech: ['tech','tech','team','driver','tech','tech','team','driver','tech','chaos','team','driver','FREE','tech','tech','driver','tech','chaos','tech','team','tech','team','tech','driver','chaos'],
        chaos: ['chaos','chaos','driver','team','chaos','chaos','driver','team','chaos','tech','driver','team','FREE','chaos','chaos','team','chaos','tech','chaos','driver','chaos','driver','chaos','team','chaos'],
        driver: ['driver','driver','driver','team','driver','driver','team','chaos','driver','driver','team','driver','FREE','driver','team','driver','chaos','team','driver','driver','driver','driver','team','driver','chaos']
    };

    function init() {
        // Check for Data
        if (typeof BINGO_CONFIG === 'undefined') {
            alert("Error: bingo_data.js not loaded!");
            return;
        }

        // Setup Firebase or Offline
        if (window.firebase && firebaseConfig.apiKey !== "YOUR_API_KEY") {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                isOffline = false;
            } catch(e) { console.log("Offline Mode"); }
        }

        renderRaces();
        
        const saved = localStorage.getItem('f1_team_name');
        if(saved) document.getElementById('teamNameInput').value = saved;
        switchState('login');
    }

    function switchState(name) {
        document.querySelectorAll('.view-login, .view-strategy, .view-game').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${name}`).classList.remove('hidden');
    }

    function login() {
        const name = document.getElementById('teamNameInput').value;
        if(!name) return alert("Enter Name");
        
        currentUser = { name, id: name.replace(/\s+/g, '_').toLowerCase() };
        localStorage.setItem('f1_team_name', name);
        document.getElementById('displayTeamName').innerText = name.toUpperCase();
        
        if(!isOffline) {
            auth.signInAnonymously();
            document.getElementById('connectionDot').classList.add('online');
            loadCloud();
        } else {
            checkLocalGrid();
        }
    }

    function checkLocalGrid() {
        const local = localStorage.getItem(`grid_${activeRace}`);
        const localRes = localStorage.getItem(`results_${activeRace}`);
        verifiedResults = localRes ? JSON.parse(localRes) : [];

        if(local) {
            currentGrid = JSON.parse(local);
            switchState('game');
            renderGrid();
        } else {
            prepareStrategyView();
            switchState('strategy');
        }
    }

    function prepareStrategyView() {
        const r = BINGO_CONFIG.races.find(x => x.id === activeRace);
        document.getElementById('stratFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
        document.getElementById('stratRaceName').innerText = r.n.toUpperCase();
    }

    function confirmStrategy(type) {
        applyTemplate(type);
        switchState('game');
        saveToServer();
    }

    function renderRaces() {
        const bar = document.getElementById('raceBar');
        bar.innerHTML = '';
        BINGO_CONFIG.races.forEach(r => {
            const div = document.createElement('div');
            div.className = `race-card ${r.id === activeRace ? 'active' : ''}`;
            div.onclick = () => { activeRace = r.id; renderRaces(); checkLocalGrid(); };
            div.innerHTML = `<img src="https://flagcdn.com/w40/${r.c}.png" class="race-flag-img"><span class="race-name">${r.n}</span><span class="race-date">${r.d}</span>`;
            bar.appendChild(div);
        });
    }

    function setPool(cat) {
        currentPoolCat = cat;
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active');
            if(b.dataset.cat === cat) b.classList.add('active');
        });
        renderPool();
    }

    function renderPool() {
        const container = document.getElementById('pool');
        container.innerHTML = '';
        BINGO_CONFIG.pool[currentPoolCat].forEach(text => {
            const chip = document.createElement('div');
            chip.className = `chip ${currentPoolCat}`;
            chip.innerText = text;
            chip.draggable = true;
            chip.ondragstart = e => { e.dataTransfer.setData('text', text); e.dataTransfer.setData('type', currentPoolCat); };
            container.appendChild(chip);
        });
    }

    function applyTemplate(t) {
        const pattern = templates[t];
        currentGrid = pattern.map(type => type === 'FREE' ? { text:"LIGHTS OUT", type:"FREE" } : null);
        renderGridStructure(pattern);
    }

    function renderGridStructure(pattern) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        pattern.forEach((type, i) => {
            const slot = document.createElement('div');
            slot.dataset.index = i;
            if(type === 'FREE') {
                slot.className = 'slot center'; slot.innerText = "LIGHTS OUT";
            } else {
                slot.className = 'slot'; slot.dataset.req = type;
                slot.ondragover = e => e.preventDefault();
                slot.ondrop = e => handleDrop(e, i, type);
                slot.onclick = () => { currentGrid[i] = null; renderGrid(); };
            }
            grid.appendChild(slot);
        });
        renderGrid();
    }

    function handleDrop(e, index, reqType) {
        e.preventDefault();
        const text = e.dataTransfer.getData('text');
        const type = e.dataTransfer.getData('type');
        if(type !== reqType) return;
        currentGrid[index] = { text, type };
        renderGrid();
        saveToServer();
    }

    function renderGrid() {
        const slots = document.querySelectorAll('.slot:not(.center)');
        slots.forEach(s => {
            const idx = s.dataset.index;
            const data = currentGrid[idx];
            s.classList.remove('matched');
            if(data) {
                s.innerText = data.text; s.className = `slot filled`; s.dataset.type = data.type;
                if(verifiedResults.includes(data.text)) s.classList.add('matched');
            } else {
                s.innerText = ''; s.className = 'slot'; delete s.dataset.type;
            }
        });
        const center = document.querySelector('.slot.center');
        if(center) center.classList.add('matched');
        updateScore();
    }

    function toggleAdmin() {
        const panel = document.getElementById('adminOverlay');
        const list = document.getElementById('adminList');
        if(panel.style.display === 'flex') { panel.style.display = 'none'; return; }
        
        panel.style.display = 'flex';
        document.getElementById('adminRaceName').innerText = activeRace.toUpperCase();
        list.innerHTML = '';
        
        let allItems = [];
        Object.values(BINGO_CONFIG.pool).forEach(arr => allItems.push(...arr));
        
        allItems.forEach(text => {
            const div = document.createElement('div');
            const isSelected = verifiedResults.includes(text);
            div.className = `toggle-item ${isSelected ? 'selected' : ''}`;
            div.innerHTML = `<span class="toggle-check"></span> ${text}`;
            div.onclick = () => div.classList.toggle('selected');
            list.appendChild(div);
        });
    }

    function publishResults() {
        const selectedDivs = document.querySelectorAll('.toggle-item.selected');
        verifiedResults = Array.from(selectedDivs).map(div => div.innerText.trim());
        if(isOffline) localStorage.setItem(`results_${activeRace}`, JSON.stringify(verifiedResults));
        renderGrid();
        document.getElementById('adminOverlay').style.display = 'none';
    }

    function updateScore() {
        let score = 0;
        currentGrid.forEach((item, i) => {
            if(i === 12) { score += 10; return; }
            if(item && verifiedResults.includes(item.text)) score += 10;
        });
        document.getElementById('currentScoreDisplay').innerText = `Race Score: ${score} pts`;
    }

    function saveToServer() {
        if(isOffline) { localStorage.setItem(`grid_${activeRace}`, JSON.stringify(currentGrid)); return; }
        db.collection('players').doc(currentUser.id).set({ name: currentUser.name, [`grid_${activeRace}`]: currentGrid }, { merge: true });
    }
    
    function loadCloud() { checkLocalGrid(); }

    window.onload = init;
</script>

</body>
</html>